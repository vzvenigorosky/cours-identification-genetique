<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Déconvolution de Mélanges</title>
    <style>
        /* --- VZVENIGOROSKY THEME --- */
        :root {
            --primary-color: #159957;
            --secondary-color: #155799;
            --highlight-color: #d73a49; /* Red for foreign alleles */
            --muted-color: #a3aab1;
            --text-color: #606c71;
            --header-color: #1e6bb8;
            --bg-color: #fdfdfd;
            --table-stripe: #f6f8fa;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            background-color: var(--bg-color);
            max-width: 1100px;
            margin: 0 auto;
        }

        /* --- NAVIGATION --- */
        .back-link {
            display: inline-block;
            margin-bottom: 10px;
            color: var(--header-color);
            text-decoration: none;
            font-weight: bold;
            border: 1px solid #e1e4e8;
            padding: 5px 10px;
            border-radius: 4px;
            background: white;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .back-link:hover {
            background-color: #f6f8fa;
            color: var(--secondary-color);
            border-color: var(--header-color);
        }

        h1, h2 { color: var(--header-color); font-weight: 700; margin-top: 20px; }
        h1 { border-bottom: 2px solid #eaecef; padding-bottom: 10px; font-size: 1.8rem;}

        .game-panel {
            border: 1px solid #e1e4e8;
            border-radius: 6px;
            padding: 20px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            margin-bottom: 30px;
        }

        /* --- DECONVOLUTION TABLE --- */
        .deconv-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 0.95rem;
        }

        .deconv-table th, .deconv-table td {
            padding: 8px;
            border: 1px solid #dfe2e5;
            text-align: center;
            vertical-align: middle;
        }

        .deconv-table th {
            background-color: var(--table-stripe);
            color: var(--secondary-color);
        }

        /* Column specific widths */
        .col-locus { width: 10%; font-weight: bold; }
        .col-victim { width: 15%; background-color: #f0f8ff; }
        .col-mix { width: 25%; background-color: #fff5f5; border-left: 2px solid #e1e4e8; border-right: 2px solid #e1e4e8; }
        .col-susp { width: 15%; }
        .col-decision { width: 20%; }

        /* --- INTERACTIVE ALLELES --- */
        .allele-btn {
            display: inline-block;
            padding: 5px 10px;
            margin: 2px;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #fff;
            cursor: pointer;
            font-family: monospace;
            font-weight: bold;
            font-size: 1em;
            transition: all 0.1s;
        }

        /* State 0: Neutral (White) */
        
        /* State 1: Victim (Grayed out) */
        .allele-btn.is-victim {
            background-color: #e1e4e8;
            color: #a3aab1;
            text-decoration: line-through;
            border-color: #e1e4e8;
        }

        /* State 2: Foreign (Red Highlight) */
        .allele-btn.is-foreign {
            background-color: var(--highlight-color);
            color: white;
            border-color: #b02a37;
            box-shadow: 0 2px 5px rgba(215, 58, 73, 0.3);
        }

        /* --- DECISION CHECKBOXES --- */
        .decision-box {
            text-align: left;
            padding-left: 10px;
            font-size: 0.85em;
        }
        .decision-box label {
            display: block;
            margin-bottom: 3px;
            cursor: pointer;
        }

        /* --- CONTROLS --- */
        .action-btn {
            background-image: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            font-weight: bold;
            margin-right: 10px;
        }
        button.secondary { background: #606c71; background-image: none; }

        .result-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .result-success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .result-fail { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        .instruction-box {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

    </style>
</head>
<body>

    <a href="accueil-exercices-master.html" class="back-link">← Retour à l'accueil</a>

    <h1>Atelier : Déconvolution de Mélanges (Agression Sexuelle)</h1>
    
    <div class="instruction-box">
        <strong>Contexte :</strong> Prélèvement vaginal post-agression. On s'attend à trouver l'ADN de la victime (V) et potentiellement celui d'un ou plusieurs agresseurs.<br>
        <strong>Mission :</strong>
        <ol style="margin-bottom:0; padding-left:20px;">
            <li>Dans la colonne <strong>"Mélange (Preuve)"</strong>, cliquez sur les allèles pour les trier :
                <ul>
                    <li><span style="color:#999; text-decoration:line-through;">1 clic (Gris)</span> : Compatible avec la Victime (à masquer).</li>
                    <li><span style="background:#d73a49; color:white; padding:0 4px; border-radius:3px;">2 clics (Rouge)</span> : Allèle étranger obligatoire.</li>
                </ul>
            </li>
            <li>Regardez les allèles étrangers restants. Sont-ils présents chez le Suspect A ? Chez le Suspect B ?</li>
            <li>Cochez les cases "Non Exclu" (Compatible) si le suspect possède les allèles requis.</li>
        </ol>
    </div>

    <div class="game-panel">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h2>Table de Comparaison</h2>
            <button class="back-link secondary" onclick="initGame()">Nouveau Cas (Aléatoire)</button>
        </div>

        <table class="deconv-table">
            <thead>
                <tr>
                    <th class="col-locus">Locus</th>
                    <th class="col-victim">Victime (Ref)</th>
                    <th class="col-mix">Mélange (Preuve)</th>
                    <th class="col-susp">Suspect A</th>
                    <th class="col-susp">Suspect B</th>
                    <th class="col-decision">Votre Décision</th>
                </tr>
            </thead>
            <tbody id="deconv-body">
                </tbody>
        </table>

        <div style="text-align:center; margin-top:20px;">
            <button class="action-btn" onclick="checkAnswer()">Valider l'Expertise</button>
        </div>
        
        <div id="result-message" class="result-box"></div>
    </div>

<script>
/**
 * DECONVOLUTION ENGINE (FIXED CLICK LISTENER)
 */

const LOCI = [
    { name: "D3S1358", min: 12, max: 19 },
    { name: "vWA",     min: 11, max: 21 }, 
    { name: "D16S539", min: 8,  max: 15 },
    { name: "CSF1PO",  min: 7,  max: 15 },
    { name: "TPOX",    min: 6,  max: 13 },
    { name: "D8S1179", min: 8,  max: 19 },
    { name: "FGA",     min: 18, max: 30 } 
];

let currentCase = {
    contributors: [], // 'A', 'B', 'Unknown'
    profiles: {} // Stores alleles for V, A, B, Mix
};

// --- GENERATORS ---

function generateGenotype(locus) {
    let a1 = Math.floor(Math.random() * (locus.max - locus.min + 1)) + locus.min;
    let a2 = Math.floor(Math.random() * (locus.max - locus.min + 1)) + locus.min;
    return [a1, a2].sort((a,b)=>a-b);
}

function generateProfile() {
    let p = {};
    LOCI.forEach(l => p[l.name] = generateGenotype(l));
    return p;
}

function createMix(contributors) {
    let mix = {};
    LOCI.forEach(l => {
        let alleles = new Set();
        // Always add Victim
        currentCase.profiles.V[l.name].forEach(a => alleles.add(a));
        
        // Add Contributors
        contributors.forEach(c => {
            let source = (c === 'Unknown') ? currentCase.profiles.Unknown : currentCase.profiles[c];
            source[l.name].forEach(a => alleles.add(a));
        });

        mix[l.name] = Array.from(alleles).sort((a,b)=>a-b);
    });
    return mix;
}

// --- INIT ---

function initGame() {
    // 1. Generate Individuals
    currentCase.profiles.V = generateProfile();
    currentCase.profiles.A = generateProfile();
    currentCase.profiles.B = generateProfile();
    currentCase.profiles.Unknown = generateProfile(); // Used for exclusion scenarios

    // 2. Determine Scenario
    const rand = Math.random();
    if (rand < 0.25) {
        currentCase.contributors = ['A']; // V + A
    } else if (rand < 0.50) {
        currentCase.contributors = ['B']; // V + B
    } else if (rand < 0.75) {
        currentCase.contributors = ['A', 'B']; // V + A + B (Mixture of 3)
    } else {
        currentCase.contributors = ['Unknown']; // V + Random (Exclusion A and B)
    }

    // 3. Create Mixture
    currentCase.profiles.Mix = createMix(currentCase.contributors);

    // 4. UI Render
    renderTable();
    document.getElementById("result-message").style.display = "none";
}

function renderTable() {
    const tbody = document.getElementById("deconv-body");
    tbody.innerHTML = "";

    LOCI.forEach(l => {
        // Create the Row
        let tr = document.createElement("tr");

        // 1. Locus Name
        let tdLoc = document.createElement("td");
        tdLoc.className = "col-locus";
        tdLoc.innerText = l.name;
        tr.appendChild(tdLoc);

        // 2. Victim
        let tdVictim = document.createElement("td");
        tdVictim.className = "col-victim";
        tdVictim.innerText = formatAlleles(currentCase.profiles.V[l.name]);
        tr.appendChild(tdVictim);

        // 3. Mixture (INTERACTIVE)
        let tdMix = document.createElement("td");
        tdMix.className = "col-mix";
        currentCase.profiles.Mix[l.name].forEach(al => {
            let btn = document.createElement("button");
            btn.className = "allele-btn"; 
            btn.innerText = al;
            // Event Listener must be attached to the element
            btn.onclick = function() { cycleBtnState(this); };
            tdMix.appendChild(btn);
        });
        tr.appendChild(tdMix);

        // 4. Suspect A
        let tdSuspA = document.createElement("td");
        tdSuspA.className = "col-susp";
        tdSuspA.innerText = formatAlleles(currentCase.profiles.A[l.name]);
        tr.appendChild(tdSuspA);

        // 5. Suspect B
        let tdSuspB = document.createElement("td");
        tdSuspB.className = "col-susp";
        tdSuspB.innerText = formatAlleles(currentCase.profiles.B[l.name]);
        tr.appendChild(tdSuspB);

        // 6. Decisions
        let tdDec = document.createElement("td");
        tdDec.className = "decision-box";
        tdDec.innerHTML = `
            <label><input type="checkbox" id="cb-A-${l.name}"> A non exclu</label>
            <label><input type="checkbox" id="cb-B-${l.name}"> B non exclu</label>
        `;
        tr.appendChild(tdDec);

        // Append Row to Body
        tbody.appendChild(tr);
    });
}

function formatAlleles(arr) {
    return arr.join(", ");
}

// --- INTERACTION ---

function cycleBtnState(btn) {
    // States: 0 (None) -> 1 (Victim/Grey) -> 2 (Foreign/Red) -> 0
    if (btn.classList.contains("is-victim")) {
        // 1 -> 2
        btn.classList.remove("is-victim");
        btn.classList.add("is-foreign");
    } else if (btn.classList.contains("is-foreign")) {
        // 2 -> 0
        btn.classList.remove("is-foreign");
    } else {
        // 0 -> 1
        btn.classList.add("is-victim");
    }
}

// --- VALIDATION ---

function checkAnswer() {
    let errors = [];
    let correctCount = 0;
    
    // Who is actually in the mix?
    let A_is_in = currentCase.contributors.includes('A');
    let B_is_in = currentCase.contributors.includes('B');

    LOCI.forEach(l => {
        let cbA = document.getElementById(`cb-A-${l.name}`).checked;
        let cbB = document.getElementById(`cb-B-${l.name}`).checked;

        // LOGIC: 
        // Suspect is "Non Exclu" (Checked) IF all their alleles are present in the mix.
        // Note: We assume 100% detection (no dropout) in this specific simplified exercise.
        
        let A_can_explain = isSubset(currentCase.profiles.A[l.name], currentCase.profiles.Mix[l.name]);
        let B_can_explain = isSubset(currentCase.profiles.B[l.name], currentCase.profiles.Mix[l.name]);

        if (cbA !== A_can_explain) {
            errors.push(`${l.name} (A)`);
        }
        if (cbB !== B_can_explain) {
            errors.push(`${l.name} (B)`);
        }
    });

    const resDiv = document.getElementById("result-message");
    
    if (errors.length === 0) {
        resDiv.className = "result-box result-success";
        
        let msg = "<strong>Analyse Parfaite.</strong><br>";
        if (A_is_in && B_is_in) msg += "Conclusion : Mélange complexe (Victime + A + B).";
        else if (A_is_in) msg += "Conclusion : Victime + Suspect A. (B est exclu).";
        else if (B_is_in) msg += "Conclusion : Victime + Suspect B. (A est exclu).";
        else msg += "Conclusion : Victime + Individu inconnu. (A et B sont exclus).";

        resDiv.innerHTML = msg;
    } else {
        resDiv.className = "result-box result-fail";
        resDiv.innerHTML = `<strong>Erreurs détectées :</strong><br>Vos conclusions d'inclusion/exclusion sont incorrectes pour les locus suivants : ${errors.join(", ")}.<br>Vérifiez si tous les allèles du suspect sont bien présents dans le mélange.`;
    }
    resDiv.style.display = "block";
}

function isSubset(suspAlleles, mixAlleles) {
    // Returns true if every allele of suspect is in mix
    return suspAlleles.every(val => mixAlleles.includes(val));
}

// Start
window.onload = initGame;

</script>
</body>
</html>